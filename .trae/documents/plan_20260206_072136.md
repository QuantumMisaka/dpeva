# 重构计划：变量管理体系优化与 UQ 动态化

基于审查报告，我制定了以下分阶段重构计划。首要任务是解决 **Critical** 级别的硬编码问题，随后完善文档与代码的一致性。

## Phase 1: UQ 模块动态化重构 (Critical Fix)
**目标**: 消除 `CollectionWorkflow` 和 `UQCalculator` 中对 `4` 个模型的硬编码依赖，支持任意数量的模型 (N-models, N>=3)。

### 1. 配置层 (`src/dpeva/config.py`)
*   在 `CollectionConfig` 类中添加 `num_models` 字段。
*   **默认值**: 引用 `constants.DEFAULT_NUM_MODELS` (通常为 4)。
*   **校验**: 确保 `num_models >= 3` (QbC 计算的最小需求)。

### 2. 计算核心层 (`src/dpeva/uncertain/calculator.py`)
*   重构 `compute_qbc_rnd` 方法签名，由接收 4 个独立参数改为接收模型预测列表：
    ```python
    def compute_qbc_rnd(self, predictions: List[PredictionData]) -> Dict[str, np.ndarray]:
    ```
*   **逻辑重写**:
    *   **Force Component Extraction**: 循环提取所有模型的 `fx, fy, fz`。
    *   **Ensemble Mean**: 计算所有模型的均值 (`np.mean(..., axis=0)`).
    *   **QbC (Variance)**: 计算所有模型相对于 Mean 的方差。
    *   **RND (Deviation)**: 计算所有模型 (1..N) 相对于主模型 (Model 0) 的偏差。

### 3. 工作流层 (`src/dpeva/workflows/collect.py`)
*   修改 `_run_uq_analysis` 方法：
    *   将 `range(4)` 循环改为 `range(self.config.num_models)`。
    *   调用 `calculator.compute_qbc_rnd(preds)` 时传入整个列表。

---

## Phase 2: 文档一致性补全 (Major Fix)
**目标**: 确保用户文档 `INPUT_PARAMETERS.md` 100% 覆盖 `config.py` 中的可配置项。

### 1. 更新 `docs/parameters/INPUT_PARAMETERS.md`
*   **补充 `CollectionConfig` 缺失参数**:
    *   `num_models`: 新增的模型数量参数。
    *   `config_path`: Slurm 自提交路径。
    *   `uq_qbc_trust_ratio` / `width`: 手动覆盖参数。
    *   `uq_rnd_rescaled_trust_ratio` / `width`: 手动覆盖参数。
    *   `uq_auto_bounds`: 自动 UQ 边界字典。
*   **补充 `FeatureConfig` 缺失参数**:
    *   `mode`: `cli` 或 `python` 执行模式。

---

## Phase 3: 代码清理与常量提取 (Minor Fix)
**目标**: 消除魔法字符串，提升代码可维护性。

### 1. 常量提取 (`src/dpeva/constants.py`)
*   定义 `DEFAULT_ANALYSIS_OUTPUT_DIR = "analysis"`。
*   定义 `DEFAULT_LOG_FILE = "collection.log"` (或其他日志文件名)。

### 2. 代码替换
*   在 `config.py` 中使用 `DEFAULT_ANALYSIS_OUTPUT_DIR` 替换 `"analysis"` 字面量。

---

## Phase 4: 验证与测试
*   **单元测试**: 运行 `tests/unit/test_filter_uq.py` 确保 UQ 计算逻辑在重构后（支持 List 输入）依然正确。
*   **集成验证**: 使用 `tests/integration/` 下的测试用例（如存在）或手动构造 3 模型和 4 模型的输入数据，验证 `CollectionWorkflow` 能否正常跑通。
