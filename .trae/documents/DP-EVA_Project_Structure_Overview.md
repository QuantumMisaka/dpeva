# DP-EVA 项目结构速览文档

## 1. 项目定位与核心逻辑
DP-EVA (Deep Potential EVolution Accelerator) 是一个专注于 DPA3 模型高效微调的主动学习框架。其核心逻辑通过“模型不确定度（UQ）”与“结构描述符（Feature）”的双重筛选，从海量无标签数据中精准选取最具代表性和高误差风险的样本，实现以最小的数据增量获取最大的模型性能提升。

## 2. 目录结构现状说明

### 2.1 核心库层 (`src/dpeva/`)
重构后的核心逻辑完全封装在 `dpeva` 包中，遵循模块化设计原则：
- **`uncertain/`**: 负责不确定度计算、筛选策略（Strict, Circle, Tangent等）及科研级可视化。
- **`feature/`**: 封装了基于 DeepPot 的原子级与结构级描述符生成。
- **`training/`**: 提供 `ParallelTrainer`，支持多模型并行微调及任务状态监控。
- **`inference/`**: 封装模型推理逻辑，解析 `dp test` 输出。
- **`submission/`**: 抽象任务提交层，支持 `local` 多进程与 `slurm` 集群调度。
- **`workflows/`**: 业务流程编排层，如 `CollectWorkflow` 串联了 UQ 计算、特征采样与数据分拣。
- **`io/`**: 统一的数据读写与格式转换工具。

### 2.2 运行入口层 (`runner/`)
包含项目的主要执行脚本，作为工作流的触发点：
- **`run_collect_workflow.py`**: 数据采集工作流入口。
- 其他预期的入口脚本（如 `run_train_workflow.py`）负责驱动各自的业务闭环。

### 2.3 辅助工具与遗留脚本 (`utils/`)
- **`uq/`**: 包含数据处理的演进过程。`uq-post-view-2.py` 是目前数据处理功能的最佳实践参考，相比 `uq-post-view.py` 在算法逻辑和代码质量上有显著提升。

## 3. 重构前后对比摘要

| 维度 | 重构前 (Pre-Refactor) | 重构后 (Post-Refactor) | 改进意义 |
| :--- | :--- | :--- | :--- |
| **组织形式** | 分散的 Shell/Python 脚本 (`utils/`) | 模块化 Python 包 (`src/dpeva/`) | 提高代码复用性与可维护性 |
| **配置管理** | 硬编码或环境变量 | 显式配置字典 (Config-driven) | 实现逻辑与参数分离，易于版本控制 |
| **并行机制** | `nohup &` (发射后不管) | `multiprocessing` (受控子进程) | 实现任务状态监控与异常捕获 |
| **任务调度** | 仅支持本地 | Local / Slurm 双后端支持 | 适应从工作站到超算集群的平滑切换 |
| **功能耦合** | UQ计算、筛选、绘图混合在单文件 | 职责单一的原子模块 | 降低修改成本，增强扩展性 |

## 4. 当前现状评估
目前重构进度约为 85%。核心业务逻辑（训练、特征、采集）已完成封装。后续重点在于完善推理后处理功能、加强集成测试以及将 `uq-post-view-2.py` 中的最佳实践全面集成到 `src/dpeva` 仓库中。
