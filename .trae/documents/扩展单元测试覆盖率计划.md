# 全栈覆盖的单元测试扩展计划 (包含训练与推理全流程)

本计划在前一版的基础上，补全了 **推理工作流 (Inference Workflow)** 的执行部分，确保测试范围从“结果分析”扩展到“任务启动”，实现对 `dpeva` 核心业务闭环的完整覆盖。

## 1. 场景映射总览

我们将测试划分为四个核心领域，每个领域直接映射到 `test/` 目录下的具体集成测试案例：

| 领域 | 核心组件 | 对应集成测试目录 | 关键测试点 |
| :--- | :--- | :--- | :--- |
| **训练** | `TrainingWorkflow`<br>`ParallelTrainer` | `test/test-v2-7` | 多模型初始化、Slurm 脚本生成、参数融合 |
| **推理** | `InferenceWorkflow`<br>`runner/dpeva_test` | `test/dptest-results-labeled`<br>`test/verification_test_run` | **模型发现、`dp test` 启动**、结果解析、指标计算 |
| **收集** | `CollectWorkflow` | `test/test-in-single-datapool`<br>`test/test-for-multiple-datapool` | 单/多池路径路由、UQ 自动阈值、数据聚合 |
| **特征** | `FeatureWorkflow` | `test/desc-test` | CLI/Python 模式切换、环境注入 |

## 2. 详细实施方案

### 2.1 推理工作流 (Inference Workflow) **[新增重点]**

**目标模块**: `src/dpeva/workflows/infer.py`, `runner/dpeva_test/run_inference.py`

*   **测试文件**: `tests/unit/workflows/test_infer_workflow_exec.py`

*   **场景 A: 推理任务启动 (Execution)**
    *   **数据源**: 模拟 `test/test-v2-7` 的输出结构（包含 `0/model.ckpt.pt` 等）。
    *   **测试逻辑**:
        1.  **模型发现**: 在 `tmp_path` 中创建虚拟的模型文件结构，验证 `InferenceWorkflow.__init__` 能否正确自动识别所有模型路径。
        2.  **命令构建**: 验证 `run()` 方法生成的 `dp test` 命令是否包含正确的 `-s` (数据), `-m` (模型), `-d` (输出) 参数。
        3.  **作业提交**: Mock `JobManager.submit`，验证是否为每个模型提交了独立的 Slurm 任务。

*   **场景 B: 结果分析 (Analysis)**
    *   **数据源**: `test/dptest-results-labeled` (`results.e.out` 等)。
    *   **测试逻辑**:
        1.  **解析器集成**: 验证 `analyze_results()` 方法能否正确调用 `TestResultParser` 读取真实输出文件。
        2.  **原子能计算**: Mock `dpdata.MultiSystems` 读取 `test/sampled_dpdata`，验证 `Cohesive Energy` (相对能量) 的计算逻辑。
        3.  **统计输出**: 验证 `statistics.json` 和 `inference_summary.csv` 是否正确生成。

### 2.2 训练工作流 (Training Workflow)

**目标模块**: `src/dpeva/workflows/train.py`

*   **测试文件**: `tests/unit/workflows/test_train_workflow_init.py`

*   **场景**: 多模型并行训练
    *   **数据源**: `test/test-v2-7/config.json`, `test/test-v2-7/input.json`。
    *   **测试逻辑**:
        1.  **工作目录隔离**: 验证 `TrainingWorkflow` 是否为 4 个模型分别创建了 `0/`, `1/`, `2/`, `3/` 文件夹。
        2.  **配置继承**: 验证子目录下的 `input.json` 是否正确继承了主配置中的 `training` 参数。

### 2.3 收集工作流 (Collect Workflow)

**目标模块**: `src/dpeva/workflows/collect.py`

*   **测试文件**: `tests/unit/workflows/test_collect_workflow_routing.py`

*   **场景**: 多数据源路由
    *   **数据源**: `test/test-for-multiple-datapool/joint_collect_config.json`。
    *   **测试逻辑**:
        1.  **路径解析**: 验证 `CollectWorkflow` 对 `testdata_dir` 和 `training_data_dir` 的区分处理。
        2.  **迭代逻辑**: 验证在 `run_loop` 中是否正确传递了当前的迭代次数。

### 2.4 特征工作流 (Feature Workflow)

**目标模块**: `src/dpeva/workflows/feature.py`

*   **测试文件**: `tests/unit/workflows/test_feature_workflow_env.py`

*   **场景**: Slurm 环境配置
    *   **数据源**: `test/desc-test/config_cli_test.json`。
    *   **测试逻辑**:
        1.  **环境注入**: 验证生成的脚本中是否包含 `source /opt/envs/deepmd3.1.2.env`。

## 3. 基础设施升级

为了支持上述测试，我们将扩展 `tests/conftest.py`：

1.  **`mock_dp_outputs` Fixture**: 自动将 `test/dptest-results-labeled` 中的文件复制到测试临时目录，模拟推理完成的状态。
2.  **`mock_model_dirs` Fixture**: 快速创建包含空 `model.ckpt.pt` 的多层目录结构，用于测试模型发现逻辑。
3.  **`RealConfigLoader` 类**: 专门用于读取项目中的真实 Config 文件，并将其中的绝对路径动态替换为测试环境路径。

## 4. 执行计划

1.  **构建 Fixtures**: 优先实现 `mock_dp_outputs` 和 `mock_model_dirs`，这是测试推理工作流的前提。
2.  **推理闭环**: 先完成 `InferenceWorkflow` 的 Execution 和 Analysis 测试，打通“后处理”环节。
3.  **训练闭环**: 完成 `TrainingWorkflow` 测试，打通“前处理”环节。
4.  **全链路验证**: 运行所有测试，确保无死角覆盖。
