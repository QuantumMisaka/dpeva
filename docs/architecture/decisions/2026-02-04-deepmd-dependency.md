# ADR: DeepMD-kit ä¾èµ–ç®¡ç†ç­–ç•¥

- Status: active
- Date: 2026-02-04
- Owners: Maintainers

## Context

DP-EVA ä½œä¸ºä¸Šå±‚å·¥ä½œæµç¼–æ’ç³»ç»Ÿï¼Œä¸»è¦é€šè¿‡ä¸¤ç§æ–¹å¼ä¸ DeepMD-kit äº¤äº’ï¼š

- CLI è°ƒç”¨ä¸ºä¸»ï¼š`dp train` / `dp test` / `dp eval-desc`ï¼ˆé€šè¿‡å‘½ä»¤æ„å»ºä¸ä½œä¸šè°ƒåº¦ç³»ç»Ÿè°ƒç”¨ï¼Œä¸ä¾èµ– DeepMD Python æºç ï¼‰
- Python API è°ƒç”¨ä¸ºè¾…ï¼šä»…ç”¨äºå°è§„æ¨¡/è°ƒè¯•çš„æœ¬åœ°æè¿°ç¬¦è®¡ç®—ï¼ˆç¯å¢ƒç¼ºå¤±æ—¶å¯é™çº§ï¼‰

å½“å‰ä»£ç æœªä½“ç°å¯¹ DeepMD-kit æºç çš„äºŒæ¬¡å¼€å‘æˆ– Patch éœ€æ±‚ã€‚

## Decision

æ‹’ç»å°† DeepMD-kit ä»¥ Git submodule æ–¹å¼å¼•å…¥ä»“åº“ï¼›é‡‡ç”¨â€œå¤–éƒ¨ç¯å¢ƒä¾èµ– + ç‰ˆæœ¬çº¦æŸ + è¿è¡Œæ—¶æ£€æŸ¥â€çš„ç­–ç•¥ç®¡ç† DeepMD-kitã€‚

## Consequences

- ä¼˜ç‚¹
  - å®‰è£…ä¸ä½¿ç”¨æ›´ç¬¦åˆç”¨æˆ·é¢„æœŸï¼ˆConda/Pip é¢„ç¼–è¯‘åŒ…ï¼‰
  - ä»“åº“ä¿æŒè½»é‡ï¼Œé¿å…æ„å»º C++/TF/PT å¤æ‚ä¾èµ–
  - å…è®¸æ ¹æ® CUDA/ç¡¬ä»¶é€‰æ‹©åˆé€‚å‘è¡ŒåŒ…
- ä»£ä»·
  - ç¯å¢ƒä¸€è‡´æ€§éœ€è¦é€šè¿‡æ–‡æ¡£ã€ä¾èµ–çº¦æŸä¸è¿è¡Œæ—¶æ£€æŸ¥ä¿éšœ

## Alternatives Considered

### Git Submodule

- ä¼˜ç‚¹ï¼šç‰ˆæœ¬é”å®šã€æºç çº§è°ƒè¯•ä¾¿åˆ©ã€Fork ç®¡ç†æ¸…æ™°
- ç¼ºç‚¹ï¼šDeepMD-kit æ„å»ºå¤æ‚ã€ä»“åº“ä½“ç§¯å¢å¤§ã€ç”¨æˆ·ä½“éªŒå·®ã€æ˜“å¼•å‘ç¯å¢ƒå†²çª

## Related

- ä¾èµ–ä¸ç‰ˆæœ¬æ£€æŸ¥ç›¸å…³å®ç°ï¼š`src/dpeva/constants.py`ï¼ˆMIN_DEEPMD_VERSIONï¼‰ä¸åˆå§‹åŒ–æ—¶çš„ç‰ˆæœ¬æ£€æŸ¥é€»è¾‘

## Appendix: Legacy Report (Full Migration)

ä»¥ä¸‹å†…å®¹è¿ç§»è‡ªå†å²æŠ€æœ¯å†³ç­–æŠ¥å‘Šï¼Œç”¨äºç¡®ä¿æ—§æ–‡æ¡£çš„åŠŸèƒ½ç‚¹/ç¤ºä¾‹/æ³¨æ„äº‹é¡¹åœ¨æ–°ä½ç½®å®Œæ•´ä¿ç•™ï¼ˆé¿å…ä¿¡æ¯ä¸¢å¤±ï¼‰ã€‚

### æŠ€æœ¯å†³ç­–æŠ¥å‘Šï¼šDeepMD-kit ä¾èµ–ç®¡ç†æ–¹æ¡ˆè¯„ä¼°

**æ—¥æœŸ**: 2026-02-04  
**çŠ¶æ€**: å·²è¯„å®¡ (Approved)  
**å†³ç­–**: ğŸ”´ **æ‹’ç»é‡‡ç”¨ Git Submodule**ï¼Œæ¨èé‡‡ç”¨ **å¤–éƒ¨ç¯å¢ƒä¾èµ– + ç‰ˆæœ¬çº¦æŸ** æ¨¡å¼ã€‚  

---

### 1. ç°çŠ¶åˆ†æï¼šDeepMD-kit è°ƒç”¨åœºæ™¯ä¸è€¦åˆåº¦

é€šè¿‡å¯¹ `dpeva` ä»£ç åº“çš„å…¨é¢å®¡è®¡ï¼Œæˆ‘ä»¬æ¢³ç†äº†é¡¹ç›®å¯¹ `deepmd-kit` çš„ä¾èµ–æƒ…å†µï¼š

#### 1.1 è°ƒç”¨æ–¹å¼

é¡¹ç›®é€šè¿‡ä¸¤ç§æ–¹å¼ä¸ `deepmd-kit` äº¤äº’ï¼Œå‘ˆç° **æ¾è€¦åˆ** ç‰¹å¾ï¼š

1. **CLI å‘½ä»¤è¡Œè°ƒç”¨ (ä¸»è¦æ–¹å¼)**
   - æ¨¡å—ï¼š`/src/dpeva/utils/command.py`ï¼ˆDPCommandBuilderï¼‰
   - åœºæ™¯ï¼š
     - `dp train`ï¼šæ¨¡å‹è®­ç»ƒï¼ˆTrainerï¼‰
     - `dp freeze`ï¼šæ¨¡å‹å¯¼å‡ºï¼ˆTrainerï¼‰
     - `dp test`ï¼šæ¨¡å‹æ¨ç†ä¸ç²¾åº¦éªŒè¯ï¼ˆInferenceï¼‰
     - `dp eval-desc`ï¼šæè¿°ç¬¦è®¡ç®—ï¼ˆFeature/Collectionï¼‰
   - ç‰¹å¾ï¼šä¾èµ–ç³»ç»Ÿ `PATH` ä¸­çš„ `dp` å¯æ‰§è¡Œæ–‡ä»¶ï¼Œé€šè¿‡ `subprocess` æˆ–ä½œä¸šè°ƒåº¦ç³»ç»Ÿï¼ˆSlurmï¼‰è°ƒç”¨ã€‚ä¸ä¾èµ– Python æºç ã€‚

2. **Python API è°ƒç”¨ (å¯é€‰æ–¹å¼)**
   - æ¨¡å—ï¼š`/src/dpeva/feature/generator.py`
   - åœºæ™¯ï¼š`DescriptorGenerator` çš„ `mode=\"python\"`ã€‚
   - ä»£ç ï¼š

```python
try:
    from deepmd.infer.deep_pot import DeepPot
except ImportError:
    _DEEPMD_AVAILABLE = False
```

   - ç‰¹å¾ï¼šä»…ç”¨äºæœ¬åœ°ç›´æ¥è®¡ç®—æè¿°ç¬¦ã€‚è‹¥ç¯å¢ƒæœªå®‰è£… Python åŒ…ï¼Œä»£ç ä¼šè‡ªåŠ¨é™çº§æˆ–ç¦ç”¨è¯¥åŠŸèƒ½ï¼Œä¸å½±å“æ ¸å¿ƒ CLI æµç¨‹ã€‚

#### 1.2 å®šåˆ¶åŒ–éœ€æ±‚

- å½“å‰ä»£ç ï¼šæœªå‘ç°å¯¹ `deepmd-kit` æ ¸å¿ƒç®—æ³•ï¼ˆå¦‚ `DescriptSeA`, `FittingNet`ï¼‰çš„æºç çº§ä¿®æ”¹æˆ– Patchã€‚
- éœ€æ±‚æ€§è´¨ï¼š`dpeva` å®šä½ä¸º **ä¸Šå±‚å·¥ä½œæµç¼–æ’ç³»ç»Ÿ (Orchestrator)**ï¼Œè€Œé `deepmd-kit` çš„äºŒæ¬¡å¼€å‘æˆ–æ’ä»¶ã€‚

---

### 2. æ–¹æ¡ˆè¯„ä¼°ï¼šGit Submodule vs ç°æœ‰æ¨¡å¼

#### 2.1 é‡‡ç”¨ Git Submodule çš„æƒè¡¡

è‹¥å°† `deepmd-kit` ä½œä¸º submodule å¼•å…¥ï¼š

- ä¼˜ç‚¹ï¼š
  - ç»å¯¹ç‰ˆæœ¬é”å®šï¼šå¯ç²¾ç¡®é”å®šåˆ°æŸæ¬¡ Commitï¼Œç¡®ä¿æ‰€æœ‰å¼€å‘è€…ä½¿ç”¨å®Œå…¨ä¸€è‡´çš„ä»£ç å¿«ç…§ã€‚
  - æºç çº§è°ƒè¯•ï¼šæ–¹ä¾¿åœ¨å¼€å‘ `dpeva` æ—¶ç›´æ¥è·³è½¬è°ƒè¯• `deepmd-kit` å†…éƒ¨ä»£ç ã€‚
  - ç§æœ‰å®šåˆ¶ï¼šè‹¥æœªæ¥éœ€ä¿®æ”¹ `deepmd-kit` C++ æ ¸å¿ƒä¸”æ— æ³•åˆå¹¶å›ä¸Šæ¸¸ï¼Œsubmodule æ˜¯ç®¡ç† Fork çš„å¥½æ–¹æ³•ã€‚
- ç¼ºç‚¹ï¼ˆé˜»ç¢æ€§å› ç´ ï¼‰ï¼š
  - æ„å»ºå¤æ‚æ€§æé«˜ï¼š`deepmd-kit` åŒ…å«å¤§é‡ C++ ä»£ç ï¼Œä¾èµ– TensorFlow/PyTorch C++ åº“ã€‚è¦æ±‚æ‰€æœ‰ `dpeva` ç”¨æˆ·åœ¨å®‰è£…æ—¶æœ¬åœ°ç¼–è¯‘ `deepmd-kit` æ˜¯ä¸ç°å®çš„ï¼ˆé€šå¸¸é€šè¿‡ Conda/Pip å®‰è£…é¢„ç¼–è¯‘åŒ…ï¼‰ã€‚
  - ä»“åº“ä½“ç§¯è†¨èƒ€ï¼š`deepmd-kit` ä»“åº“è¾ƒå¤§ï¼Œå¢åŠ  `git clone` æ—¶é—´ã€‚
  - ç”¨æˆ·ä½“éªŒå·®ï¼šæ™®é€šç”¨æˆ·åªæƒ³ `pip install dpeva`ï¼Œä¸å¸Œæœ›å¤„ç†å­æ¨¡å—åŒæ­¥å’Œç¼–è¯‘é”™è¯¯ã€‚
  - ç¯å¢ƒå†²çªï¼šSubmodule å¼ºåˆ¶æŒ‡å®šç‰ˆæœ¬å¯èƒ½ä¸ç”¨æˆ·ç¯å¢ƒä¸­å·²å®‰è£…çš„ `deepmd-kit`ï¼ˆå¦‚ç³»ç»Ÿçº§ Conda ç¯å¢ƒï¼‰å†²çªã€‚

#### 2.2 å®˜æ–¹å‘å¸ƒç‰ˆæœ¬ (Pip/Conda) çš„æƒè¡¡

- ä¼˜ç‚¹ï¼š
  - å®‰è£…ä¾¿æ·ï¼š`pip install deepmd-kit` å³å¯è·å–é¢„ç¼–è¯‘åŒ…ã€‚
  - è§£è€¦ï¼š`dpeva` åªå…³æ³¨å¦‚ä½•è°ƒç”¨ï¼Œä¸å…³æ³¨å¦‚ä½•æ„å»ºã€‚
  - å…¼å®¹æ€§ï¼šå…è®¸ç”¨æˆ·æ ¹æ®ç¡¬ä»¶ï¼ˆCUDA ç‰ˆæœ¬ï¼‰è‡ªç”±é€‰æ‹©åŒ¹é…çš„ DeepMD ç‰ˆæœ¬ã€‚

---

### 3. å†³ç­–ç»“è®º

åŸºäºä¸Šè¿°åˆ†æï¼Œæˆ‘ä»¬ **å¼ºçƒˆä¸å»ºè®®** ä½¿ç”¨ Git Submoduleã€‚

æ ¸å¿ƒç†ç”±ï¼š

1. æ„å»ºæˆæœ¬è¿‡é«˜ï¼š`dpeva` æ˜¯ Python çº¯ä»£ç é¡¹ç›®ï¼Œå¼•å…¥éœ€ç¼–è¯‘çš„ C++ å­æ¨¡å—ä¼šç ´åé¡¹ç›®çš„è½»é‡çº§ç‰¹æ€§ã€‚
2. å®šä½ä¸ç¬¦ï¼š`dpeva` æ˜¯ `deepmd-kit` çš„ä½¿ç”¨è€…ï¼Œè€Œéæ‰©å±•è€…ã€‚
3. ç‰ˆæœ¬ç¨³å®šæ€§ï¼šé€šè¿‡ `/pyproject.toml` çš„ç‰ˆæœ¬çº¦æŸè¶³ä»¥æ»¡è¶³ç¨³å®šæ€§éœ€æ±‚ã€‚

---

### 4. å®æ–½æ–¹æ¡ˆï¼šæ›¿ä»£ä¾èµ–ç®¡ç†ç­–ç•¥

æ—¢ç„¶æ‹’ç» Submoduleï¼Œæˆ‘ä»¬éœ€è¦æ›´è§„èŒƒåœ°ç®¡ç†å¤–éƒ¨ä¾èµ–ï¼Œé˜²æ­¢â€œç¯å¢ƒä¸ä¸€è‡´â€å¯¼è‡´çš„é—®é¢˜ã€‚

#### 4.1 ä¾èµ–å£°æ˜è§„èŒƒåŒ–

å»ºè®®æ ¹æ®ä½¿ç”¨ç¨‹åº¦åˆ†çº§å£°æ˜ï¼ˆç¤ºä¾‹ï¼‰ï¼š

```toml
[project]
name = \"dpeva\"
dependencies = [
    \"dpdata>=0.2.13\",
    \"numpy\",
    \"pandas\",
    \"pydantic>=2.0\"
]

[project.optional-dependencies]
local = [
    \"deepmd-kit>=2.2.0\"
]
```

#### 4.2 è¿è¡Œæ—¶ç‰ˆæœ¬æ£€æŸ¥ (Runtime Version Check)

åœ¨ `dpeva` å¯åŠ¨æ—¶å¢åŠ ç‰ˆæœ¬æ£€æŸ¥é€»è¾‘ï¼Œç¡®ä¿ç¯å¢ƒä¸­çš„ `dp` å‘½ä»¤ç‰ˆæœ¬ç¬¦åˆè¦æ±‚ã€‚

å»ºè®®æ–°å¢æ¨¡å—ï¼š`/src/dpeva/utils/env_check.py`ï¼ˆæˆ–ç­‰ä»·å®ç°ï¼‰

```python
import subprocess
from packaging import version

MIN_DEEPMD_VERSION = \"2.0.0\"

def check_deepmd_version():
    try:
        out = subprocess.check_output([\"dp\", \"--version\"], text=True).strip()
    except (FileNotFoundError, subprocess.CalledProcessError):
        raise RuntimeError(\"DeepMD-kit not found. Please install deepmd-kit and ensure 'dp' is in PATH.\")
```

#### 4.3 CI/CD ç­–ç•¥

- åŸºæœ¬ç­–ç•¥ï¼šåœ¨ CI ä¸­å¯¹ `dpeva` è‡ªèº«çš„å•å…ƒæµ‹è¯•ä¸å¼ºä¾èµ– `dp`ï¼Œå¯¹ä¾èµ– `dp` çš„è·¯å¾„ä½¿ç”¨è·³è¿‡æˆ–åˆ†å±‚ CIï¼ˆå…·å¤‡ DeepMD ç¯å¢ƒçš„ runner å†è·‘ï¼‰ã€‚
- é›†æˆæµ‹è¯•ï¼šå»ºè®®åœ¨å…·å¤‡ Slurm/DeepMD çš„ç¯å¢ƒè·‘ `tests/integration`ï¼ˆä¸ `/docs/guides/testing/*` å¯¹é½ï¼‰ã€‚

#### 4.4 æ–‡æ¡£è¯´æ˜

- å®‰è£…ä¸ç¯å¢ƒå‡†å¤‡ï¼š`/docs/guides/installation.md`
- DeepMD ä¾èµ–ç­–ç•¥ï¼ˆæœ¬æ–‡æ¡£ ADRï¼‰

---

### 5. æ€»ç»“

DeepMD-kit å±äºé‡ä¾èµ–ç»„ä»¶ï¼Œsubmodule å¼•å…¥ä¼šæ˜¾è‘—æ”¾å¤§æ„å»ºä¸ç»´æŠ¤æˆæœ¬ã€‚å¯¹äº DP-EVA è¿™ç§ä¸Šå±‚ç¼–æ’ç³»ç»Ÿï¼Œåº”ä¼˜å…ˆé‡‡ç”¨å¤–éƒ¨ç¯å¢ƒä¾èµ– + ç‰ˆæœ¬çº¦æŸ + è¿è¡Œæ—¶æ£€æŸ¥çš„ç­–ç•¥ï¼Œä»¥è·å¾—æ›´å¥½çš„å¯ç”¨æ€§ä¸å¯ç»´æŠ¤æ€§ã€‚
