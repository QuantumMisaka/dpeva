# 结构描述符模长物理意义验证报告

- Status: active
- Audience: Researchers / Developers
- Last-Updated: 2026-02-18
- Related:
  - 配套图像：../design/modulo_distribution.png

## 1. 理论假设
我们定义结构描述符 $\mathbf{D}_{struct}$ 为所有归一化原子描述符 $\mathbf{u}_i = \frac{\mathbf{d}_i}{\|\mathbf{d}_i\|}$ 的平均值：
$$ \mathbf{D}_{struct} = \frac{1}{N} \sum_{i=1}^{N} \mathbf{u}_i $$

我们关注的物理量是其模长（Modulo） $M = \|\mathbf{D}_{struct}\|$。

根据向量加法原理：
$$ M^2 = \|\mathbf{D}_{struct}\|^2 = \frac{1}{N^2} \sum_{i,j} \mathbf{u}_i \cdot \mathbf{u}_j = \frac{1}{N^2} \sum_{i,j} \cos \theta_{ij} $$
其中 $\theta_{ij}$ 是原子 $i$ 和原子 $j$ 在高维描述符空间中的夹角。

*   **假设 1 (有序/相似)**：如果所有原子的局部环境完全相同（如完美单晶），则 $\mathbf{u}_i = \mathbf{u}_j$，故 $\cos \theta_{ij} = 1$，此时 $M = 1$。
*   **假设 2 (无序/多样)**：如果原子环境差异巨大（如高熵合金、非晶、复杂分子），向量 $\mathbf{u}_i$ 指向高维空间的各个方向，相互抵消，导致平均余弦值降低，故 $M \ll 1$。

---

## 2. 实践验证方案
我们使用数据集 `other_dpdata_test` 和对应的描述符 `desc_pool_test` 进行验证。
1.  遍历所有结构，计算每个结构的模长 $M$。
2.  统计 $M$ 的分布情况。
3.  检查 $M$ 值最高（Top 10）和最低（Bottom 10）的结构，分析其化学组成和可能的结构特征。

---

## 3. 验证结果分析

### 3.1 总体统计
对 **12,103** 个结构进行了分析，结果如下：
*   **Mean**: 0.810
*   **Max**: 1.000 (理论最大值，验证了假设的上限)
*   **Min**: 0.548 (显著低于 1，说明存在显著的环境差异)

### 3.2 极端情况分析

#### **Case A: 模长接近 1.0 (高度有序/简单)**
排名前 10 的结构均为 **`C0Fe0H2O0`**（即 **H2 分子**）。
*   **分析**：H2 分子包含两个氢原子。由于对称性，这两个氢原子的局部环境是**完全等价**的（镜像对称）。
*   **向量表现**：$\mathbf{u}_1 = \mathbf{u}_2$（或极度接近）。
*   **模长**：$\|\frac{\mathbf{u}_1 + \mathbf{u}_2}{2}\| \approx \|\mathbf{u}_1\| = 1.0$。
*   **结论**：验证了假设，环境完全一致的系统模长为 1。

#### **Case B: 模长接近 0.55 (高度无序/复杂)**
排名倒数 10 的结构均为 **`C6Fe1H0O6`**。
*   **分析**：这是一个包含 C、Fe、O 的复杂团簇或分子（可能是 Fe-C-O 配合物）。
*   **组成**：包含 3 种不同元素（Fe, C, O），且化学计量比复杂 (6:1:6)。
*   **环境差异**：
    *   Fe 原子的环境与 C、O 完全不同。
    *   C 原子可能处于不同的成键状态。
    *   O 原子可能处于端基或桥接位置。
*   **向量表现**：不同元素的原子描述符在高维空间中占据完全不同的区域（方向几乎正交或夹角很大）。例如，Fe 的描述符与 C 的描述符差异巨大。
*   **模长**：不同方向的向量叠加导致显著的“相消干涉”，使得模长大幅下降至 0.55 左右。
*   **结论**：验证了假设，原子环境复杂、元素种类多样的系统模长显著降低。

---

## 4. 最终结论
通过对实际数据的计算与分析，我们证实了这一理论推断：

1.  **原子归一化之后的结构描述符模长确实蕴含了物理意义**：它是衡量系统“原子环境一致性”或“结构单一性”的有效序参量。
2.  **$M \to 1$**：对应于原子环境高度均一的体系（如单质、简单对称分子、完美晶体）。
3.  **$M \to 0$ (或显著降低)**：对应于原子环境高度多样化的体系（如多组分复杂系统、非晶、缺陷结构）。

因此，在进行 DIRECT 采样或聚类分析时，先进行原子归一化，再求平均，最后记录模长作为特征之一（或进行结构归一化以消除此影响专注于方向），是非常科学且符合物理直觉的处理方式。您最初提出的“模长反映有序度”的直觉是完全正确的。

## 5. 实际实现

以下为在统一数据集（v2-7-20873）上，通过不同归一化预处理的描述符，采样2000个结构后，以不同方式训练得到的模型在训练集和验证集上的表现

### 验证集

| 归一化策略 | 训练维里 | 系统数 | 能量/原子 MAE (eV) | 能量/原子 RMSE (eV) | 力 MAE (eV/Å) | 力 RMSE (eV/Å) | 维里/原子 MAE (eV) | 维里/原子 RMSE (eV) |
| :--- | :---: | :---: | :---: | :---: | :---: | :---: | :---: | :---: |
| 仅原子 | 否 | 568 | **0.0030** | **0.0042** | 0.0691 | 0.0981 | 0.0768 | 0.2805 |
| 仅原子 | 是 | 568 | 0.0048 | 0.0069 | 0.0866 | 0.1271 | 0.0697 | 0.2552 |
| 结构+原子 | 否 | 553 | 0.0032 | 0.0044 | 0.0692 | 0.0993 | 0.0777 | 0.2830 |
| 结构+原子 | 是 | 553 | 0.0043 | 0.0065 | 0.0842 | 0.1238 | 0.0746 | 0.2660 |
| 仅结构 | 否 | 566 | 0.0044 | 0.0055 | **0.0683** | **0.0964** | 0.0766 | 0.2789 |
| 仅结构 | 是 | 566 | 0.0046 | 0.0065 | 0.0826 | 0.1186 | **0.0687** | **0.2506** |

### 训练集

| 归一化策略 | 训练维里 | 系统数 | 能量/原子 MAE (eV) | 能量/原子 RMSE (eV) | 力 MAE (eV/Å) | 力 RMSE (eV/Å) | 维里/原子 MAE (eV) | 维里/原子 RMSE (eV) |
| :--- | :---: | :---: | :---: | :---: | :---: | :---: | :---: | :---: |
| 仅原子 | 否 | 84 | **0.0024** | **0.0032** | **0.0512** | **0.0695** | 0.0710 | 0.2620 |
| 仅原子 | 是 | 84 | 0.0048 | 0.0068 | 0.0703 | 0.1008 | 0.0469 | 0.1679 |
| 结构+原子 | 否 | 80 | 0.0027 | 0.0035 | 0.0529 | 0.0717 | 0.0698 | 0.2393 |
| 结构+原子 | 是 | 80 | 0.0042 | 0.0059 | 0.0713 | 0.1043 | **0.0441** | **0.1096** |
| 仅结构 | 否 | 80 | 0.0040 | 0.0048 | 0.0533 | 0.0721 | 0.0755 | 0.2766 |
| 仅结构 | 是 | 80 | 0.0045 | 0.0063 | 0.0746 | 0.1090 | 0.0483 | 0.1586 |

注：由于训练（尤其是多卡训练）存在一定随机性，验证结果（尤其是能量验证结果）在多次不同的训练中不一定可复现。

## 6. 总结与建议

结合**描述符模长物理意义分析**（第3、4节）与**归一化策略实战验证**（第5节），我们得出以下结论：

1.  **模长的物理价值**：
    *   模长 $M$ 是衡量系统原子环境一致性的重要序参量。保留模长信息（即采用**仅原子归一化**）能使描述符包含更多结构有序度的信息。
    *   实战数据证实了这一点：**仅原子归一化**策略在训练集和验证集的**能量预测**（Energy/Atom RMSE）上均取得了最佳表现（验证集 0.0042 eV vs 0.0055 eV），证明模长信息对能量拟合至关重要。

2.  **归一化策略的权衡**：
    *   **仅原子归一化（推荐）**：保留了模长信息，特征信息量最大。在**能量精度**上表现最优，且在训练集上对力和能量的拟合均为最佳。这是**首选方案**，特别适合对势函数能量面精度要求高的场景。
    *   **仅结构归一化**：消除了模长影响，强制所有结构特征位于单位球面上，模型更专注于方向性差异。在验证集的**力预测**（Force RMSE）上略有优势（0.0964 eV/Å vs 0.0981 eV/Å）。如果任务对力的精度极度敏感，或在某些特殊体系中模长变化范围过大导致训练不稳定，可作为备选方案。
    *   **结构+原子归一化**：表现介于两者之间或略差，不具备明显优势。

3.  **结论**：
    从物理意义和验证结果来看，更为推荐采用 **仅原子归一化** 策略。这不仅在理论上保留了反映结构有序度的模长物理量，更在实战中展现了更优的能量预测精度和极具竞争力的力预测精度，是兼顾物理意义与模型性能的最佳选择。

## 7. 项目当前实现

本项目当前实现采用“先平均，后归一化”的“仅结构归一化”策略。主要是为了数学一致性（参与到DIERCT方法PCA降维+Birch聚类的描述符理应是单位向量）和算法稳定性。并且“仅结构归一化”策略在实战中效果也不差，在验证集的原子受力上也最好。

与此同时，单从此次测试结果来看，通过“仅原子归一化”方法有如下好处：

- 能量精度显著提升（核心理由） 根据您的报告数据，在验证集上，采用“仅原子归一化”策略后， 能量/原子 RMSE 从 0.0055 eV 降低到 0.0042 eV，精度提升了约 24% 。对于机器学习势函数而言，能量面的准确性是热力学性质预测（如相图、反应热）的基础，这一提升非常可观。
- 找回丢失的物理维度 当前策略强制将所有结构描述符投影到单位球面上（模长恒为 1），这相当于人为抹去了“结构有序度”这一物理信息。报告分析指出，模长  M 是一个有效的序参量（  M → 1 表示高度有序/一致，  M → 0 表示高度无序/复杂）。保留这一维度有助于模型区分简单晶体和复杂缺陷结构，从而更合理地分配拟合能力。
- 力精度的损失可接受 虽然“仅原子归一化”在力的 RMSE 上略有增加（0.0964  → 0.0981 eV/Å，约 1.8%），但相对于能量精度的巨大提升，这一代价是微小且可接受的。

然而，DIRECT采样确实“必须”使用单位向量

- 消除密度偏差 ：如果不进行 L2 归一化，无序结构（模长 M ≈ 0.5 ）在特征空间中会聚集在原点附近，形成一个高密度的“团”；而有序结构（ M ≈ 1.0 ）分布在较远的单位球面上。
- Birch 聚类的特性 ：Birch 算法基于欧氏距离和半径阈值。原点附近的高密度区域容易被聚类算法误认为是一个或少数几个簇。
- 后果 ：如果直接使用未归一化的描述符进行采样，算法会严重 低估无序结构的多样性 ，导致对高熵/非晶/缺陷区域的 欠采样 。而这些区域往往是主动学习最需要覆盖的高不确定性区域。
- 结论 ： 进入 PCA 和 Birch 聚类的向量，确实理应是模长为 1 的单位向量。

可行修改方案
1. 保留“仅结构归一化”策略（当前选择）
2. 修改为”仅原子归一化“策略
3. 兼容“原子归一化”和“结构归一化”两个选项（都打开则是结构+原子归一化），并将相关“是否打开原子/结构归一化”的选项添加到配置文件中。

