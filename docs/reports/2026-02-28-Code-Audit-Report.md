         
ç»è¿‡å¯¹ `dpeva` é¡¹ç›®ä»£ç åº“çš„è¯¦ç»†æ£€æŸ¥ï¼Œä»¥ä¸‹æ˜¯é’ˆå¯¹ä½ æå‡ºçš„ 6 é¡¹ä»»åŠ¡çš„æ£€æŸ¥ç»“æœæŠ¥å‘Šã€‚æˆ‘ä»¬éµå¾ª **Zen of Python** çš„å“²å­¦ï¼Œé‡ç‚¹è¯†åˆ«ç¡¬ç¼–ç ã€é­”æœ¯æ•°å­—ã€ç¼ºå¤±æ–‡æ¡£åŠä»£ç è´¨é‡é£é™©ã€‚

å·²ç»ç¡®ä¿æœç´¢ç»“æœè¦†ç›–äº† `src` ç›®å½•ä¸‹çš„æ‰€æœ‰ç›¸å…³æ¨¡å—ï¼Œæ£€æŸ¥ç»“æœå¦‚ä¸‹ï¼š

### **1. æ£€æŸ¥ç¡¬ç¼–ç è·¯å¾„ (src/dpeva/uncertain/visualization.py)**
åœ¨è¯¥æ–‡ä»¶ä¸­å‘ç°å¤§é‡ä½¿ç”¨å­—ç¬¦ä¸²æ‹¼æ¥è€Œé `os.path.join` çš„ç¡¬ç¼–ç è·¯å¾„è¡Œä¸ºï¼Œè¿™è¿åäº†è·¨å¹³å°å…¼å®¹æ€§çš„æœ€ä½³å®è·µï¼š
- **ç¡¬ç¼–ç æ–‡ä»¶å**ï¼š
    - `UQ-force.png` (ç¬¬ 71 è¡Œ)
    - `UQ-force-rescaled.png` (ç¬¬ 88 è¡Œ)
    - `UQ-diff-UQ-parity.png` (ç¬¬ 178 è¡Œ)
    - `UQ-diff-fdiff-parity.png` (ç¬¬ 190 è¡Œ)
    - `UQ-force-qbc-rnd-fdiff-scatter.png` (ç¬¬ 212 è¡Œ)
    - `UQ-force-qbc-rnd-identity-scatter.png` (ç¬¬ 236 è¡Œ)
    - `UQ-force-qbc-rnd-identity-scatter-truncated.png` (ç¬¬ 276 è¡Œ)
    - `UQ-QbC-Candidate-fdiff-parity.png` (ç¬¬ 298 è¡Œ)
    - `UQ-RND-Candidate-fdiff-parity.png` (ç¬¬ 310 è¡Œ)
    - `explained_variance.png` (ç¬¬ 339 è¡Œ)
    - `coverage_score.png` (ç¬¬ 359 è¡Œ)
    - `Final_sampled_PCAview.png` (ç¬¬ 408 è¡Œ)
- **é£é™©**ï¼šæ‰€æœ‰è¿™äº›è·¯å¾„éƒ½ä½¿ç”¨äº† `f"{self.save_dir}/filename.png"` æ ¼å¼ã€‚å»ºè®®ç»Ÿä¸€ä½¿ç”¨ `os.path.join(self.save_dir, "filename.png")`ã€‚

### **2. æ£€æŸ¥ 'eV/atom' (src/dpeva/analysis/managers.py)**
åœ¨ `UnifiedAnalysisManager` ç±»ä¸­å‘ç°å¤šå¤„ç¡¬ç¼–ç çš„å•ä½å­—ç¬¦ä¸²ï¼š
- **å…·ä½“ä½ç½®**ï¼šç¬¬ 211, 215, 221, 223, 231, 237, 238, 241 è¡Œå‡ç›´æ¥ä½¿ç”¨äº† `'eV/atom'`ã€‚
- **å…¶ä»–å•ä½**ï¼šè¿˜å‘ç°äº† `'eV/A'` (ç¬¬ 213, 217, 248, 252 è¡Œ) å’Œ `'eV'` (ç¬¬ 257, 260 è¡Œ) çš„ç¡¬ç¼–ç ã€‚
- **æ”¹è¿›å»ºè®®**ï¼šåº”åœ¨ `src/dpeva/constants.py` ä¸­å®šä¹‰ `UNIT_ENERGY_PER_ATOM = "eV/atom"` ç­‰å¸¸é‡å¹¶å¼•ç”¨ã€‚

### **3. æ£€æŸ¥é­”æœ¯ç§å­ (src/dpeva/training/managers.py)**
åœ¨ `TrainingConfigManager` ç±»ä¸­å‘ç°äº†æ˜æ˜¾çš„é­”æœ¯ç§å­ï¼š
- **ä»£ç ä½ç½®**ï¼š[managers.py:L65](file:///home/pku-jianghong/liuzhaoqing/work/ft2dp-dpeva/dpeva/src/dpeva/training/managers.py#L65)
- **å…·ä½“å†…å®¹**ï¼š`default_seeds = [19090, 42, 10032, 2933]`ã€‚
- **é£é™©**ï¼šè¿™äº›æ•°å­—ç¼ºä¹è§£é‡Šï¼Œä¸”ç›´æ¥ç¡¬ç¼–ç åœ¨é€»è¾‘æ–¹æ³•ä¸­ã€‚

### **4. æ£€æŸ¥ç¼ºå¤±çš„ Docstrings**
- **src/dpeva/cli.py**ï¼š**ä¸¥é‡ç¼ºå¤±**ã€‚è¯¥æ–‡ä»¶å®Œå…¨æ²¡æœ‰æ¨¡å—çº§ docstringï¼Œä¸”æ‰€æœ‰å¤„ç†å‡½æ•°ï¼ˆå¦‚ `handle_train`, `handle_infer` ç­‰ï¼‰å‡æœªç¼–å†™ docstringã€‚
- **src/dpeva/workflows/**ï¼š
    - è¯¥ç›®å½•ä¸‹çš„ä¸»è¦ workflow ç±»ï¼ˆå¦‚ `TrainingWorkflow`, `InferenceWorkflow`ï¼‰å‡åŒ…å«åŸºæœ¬çš„ç±»å’Œ `__init__` docstringã€‚
    - ä½†éƒ¨åˆ†å†…éƒ¨æ–¹æ³•ï¼ˆå¦‚ `_setup_logger`ï¼‰å’Œä¸€äº›å¤æ‚çš„è¾…åŠ©å‡½æ•°ä»ç¼ºä¹è¯¦ç»†çš„å‚æ•°è¯´æ˜ã€‚

### **5. æ‰«æå…¶ä»–ç¡¬ç¼–ç è·¯å¾„ä¸é­”æœ¯æ•°å­—**
- **å…¶ä»–ç¡¬ç¼–ç è·¯å¾„**ï¼š
    - `src/dpeva/constants.py`: `DEFAULT_PROJECT_DIR = "./"` (ç¬¬ 36 è¡Œ)
    - `src/dpeva/utils/banner.py`: `PROJECT_URL = "https://github.com/QuantumMisaka/dpeva"` (ç¬¬ 13 è¡Œ)
    - `src/dpeva/io/dataset.py`: `deepmd/npy/mixed` ç­‰æ ¼å¼å­—ç¬¦ä¸² (ç¬¬ 20, 31, 61 è¡Œ)
- **å…¶ä»–é­”æœ¯æ•°å­—**ï¼š
    - `src/dpeva/constants.py` ä¸­è™½ç„¶å°†å¾ˆå¤šæ•°å­—å®šä¹‰ä¸ºäº†å¸¸é‡ï¼ˆå¦‚ `DEFAULT_OMP_THREADS = 4`ï¼‰ï¼Œä½†ä»æœ‰ä¸€äº›æ•£è½åœ¨ä»£ç ä¸­ï¼š
        - `src/dpeva/io/collection.py`: `1e-12` ä½œä¸º epsilon (ç¬¬ 137 è¡Œ)ã€‚
        - `src/dpeva/sampling/manager.py`: `direct_thr_init = 0.1` (ç¬¬ 25 è¡Œ)ã€‚
        - `src/dpeva/utils/logs.py`: `10 * 1024 * 1024` (10MB) ç¡¬ç¼–ç åœ¨å‚æ•°é»˜è®¤å€¼ä¸­ã€‚

### **6. æ£€æŸ¥æ³¨é‡Šæ‰çš„ä»£ç  (Commented out code)**
ç»è¿‡å…¨å±€æ‰«æï¼Œæœªå‘ç°å¤§è§„æ¨¡çš„åŠŸèƒ½æ€§ä»£ç è¢«æ³¨é‡Šæ‰çš„æƒ…å†µï¼ˆä¾‹å¦‚è¢«æ³¨é‡Šæ‰çš„å‡½æ•°ä½“æˆ–å¤§æ®µé€»è¾‘ï¼‰ã€‚
- ç°æœ‰çš„ `#` å¼€å¤´è¡Œå¤§å¤šæ˜¯ï¼š
    - æ­¥éª¤è¯´æ˜ï¼ˆå¦‚ `# 1. Initialize IO Manager`ï¼‰ã€‚
    - è°ƒè¯•æ—¶çš„ä¸´æ—¶æ—¥å¿—å…³é—­è¯´æ˜ï¼ˆå¦‚ `capture_stdout=False` çš„æ³¨é‡Šè§£é‡Šï¼‰ã€‚
    - å¤æ‚çš„å…¬å¼è¯´æ˜ï¼ˆå¦‚åœ¨ `src/dpeva/inference/stats.py` ä¸­å¯¹èƒ½é‡è®¡ç®—å…¬å¼çš„è§£é‡Šï¼‰ã€‚
- **ç»“è®º**ï¼šä»£ç åº“åœ¨æ¸…ç†åºŸå¼ƒä»£ç æ–¹é¢è¡¨ç°è‰¯å¥½ã€‚

### **æ€»ç»“å»ºè®®**
1. **é‡æ„è·¯å¾„å¤„ç†**ï¼šåœ¨ `visualization.py` ä¸­å¼•å…¥ `os.path.join` æˆ– `pathlib`ã€‚
2. **å¸¸é‡åŒ–å•ä½**ï¼šå°† `'eV/atom'` ç­‰å•ä½å­—ç¬¦ä¸²ç§»è‡³ `constants.py`ã€‚
3. **æ¶ˆé™¤é­”æœ¯ç§å­**ï¼šä¸º `default_seeds` æä¾›é…ç½®é¡¹æˆ–è¯¦ç»†æ³¨é‡Šå…¶æ¥æºã€‚
4. **è¡¥å…¨ CLI æ–‡æ¡£**ï¼šæŒ‰ç…§é¡¹ç›®è§„åˆ™ï¼Œä¸º `cli.py` è¡¥å…¨ docstrings ä»¥æå‡å¯ç»´æŠ¤æ€§ã€‚
          
é€šè¿‡å¯¹ `dpeva` é¡¹ç›®ï¼ˆcommit: `6f991bc`ï¼‰çš„æ·±åº¦å®¡è®¡ï¼Œæˆ‘å·²å®Œæˆå…¨éƒ¨ä¸‰é¡¹è´¨é‡é—¨ç¦çš„æ£€æŸ¥ï¼Œå¹¶ä»”ç»†ç ”è¯»äº†ä¸Šä¸€ä½å®¡è®¡è€…çš„æŠ¥å‘Šã€‚ä»¥ä¸‹æ˜¯è¯¦ç»†çš„å®¡è®¡ç»“è®ºä¸ä¿®å¤è®¡åˆ’ã€‚

### A. ä»£ç å®¡è®¡æŠ¥å‘Š (Code Audit Report)

**å®¡è®¡æ¦‚è§ˆ**
- **å®¡è®¡å¯¹è±¡**: DP-EVA (v0.4.5)
- **Commit SHA**: `6f991bcbe8f7818af74a07ac2ccdfa8cc69dd577`
- **å®¡è®¡æ—¥æœŸ**: 2026-02-28
- **æ€»ä½“ç»“è®º**: ğŸ”´ **FAILED** (æœªé€šè¿‡)
- **ä¸»è¦é£é™©**: ä»£ç ä¸­å­˜åœ¨å¤šå¤„ç¡¬ç¼–ç è·¯å¾„ä¸é­”æ³•å€¼ï¼Œä¸¥é‡å½±å“è·¨å¹³å°è¿ç§»ä¸ç»´æŠ¤ï¼›æ ¸å¿ƒæ¥å£ç¼ºå¤±æ–‡æ¡£å­—ç¬¦ä¸²ï¼Œé™ä½äº†ä»£ç çš„å¯è¯»æ€§ä¸åä½œæ•ˆç‡ã€‚

---

#### 1. é—¨ç¦ä¸€ï¼šä»£ç å¯ç»´æŠ¤æ€§ (Maintainability Gate) - ğŸ”´ FAILED

**1.1 ç¡¬ç¼–ç è·¯å¾„ (Hardcoded Paths) - [P0]**
> è§„åˆ™ï¼šç¦æ­¢å‡ºç°ç¡¬ç¼–ç ç»å¯¹è·¯å¾„ä¸ç¡¬ç¼–ç ç›¸å¯¹è·¯å¾„ã€‚

*   **è¿è§„è¯æ®**: `src/dpeva/uncertain/visualization.py` ä¸­å¤§é‡ä½¿ç”¨å­—ç¬¦ä¸²æ‹¼æ¥æ„å»ºæ–‡ä»¶è·¯å¾„ï¼Œè€Œé `os.path.join` æˆ– `pathlib`ã€‚
    *   **ä½ç½®**: `L71`, `L88`, `L178`, `L190`, `L212`, `L236`, `L276`, `L298`, `L310`, `L339`, `L359`, `L408`
    *   **ä»£ç ç‰‡æ®µ**: `f"{self.save_dir}/UQ-force.png"`
    *   **é£é™©**: åœ¨ Windows ç¯å¢ƒä¸‹å¯èƒ½å› è·¯å¾„åˆ†éš”ç¬¦é—®é¢˜å¯¼è‡´æ–‡ä»¶æ— æ³•æ‰¾åˆ°ï¼›ä¿®æ”¹æ–‡ä»¶åéœ€è¦é€šè¿‡æœç´¢æ›¿æ¢ï¼Œå®¹æ˜“é—æ¼ã€‚

**1.2 é­”æ³•å€¼ (Magic Numbers/Strings) - [P0/P1]**
> è§„åˆ™ï¼šç¦æ­¢å‡ºç° magic numberã€magic stringã€‚

*   **è¿è§„è¯æ® 1**: `src/dpeva/analysis/managers.py` ä¸­ç¡¬ç¼–ç ç‰©ç†å•ä½ã€‚
    *   **ä½ç½®**: `L211`, `L215`, `L221` ç­‰å¤šå¤„ã€‚
    *   **ä»£ç ç‰‡æ®µ**: `unit="eV/atom"`
    *   **é£é™©**: è‹¥åç»­éœ€è¦æ”¯æŒ `meV/atom` æˆ–å…¶ä»–å•ä½ï¼Œéœ€ä¿®æ”¹å¤šå¤„é€»è¾‘ï¼Œææ˜“å¼•å…¥ Bugã€‚
*   **è¿è§„è¯æ® 2**: `src/dpeva/training/managers.py` ä¸­ç¡¬ç¼–ç éšæœºç§å­åˆ—è¡¨ã€‚
    *   **ä½ç½®**: `L65`
    *   **ä»£ç ç‰‡æ®µ**: `default_seeds = [19090, 42, 10032, 2933]`
    *   **é£é™©**: è¿™äº›æ•°å­—ç¼ºä¹ä¸šåŠ¡å«ä¹‰è§£é‡Šï¼Œä¸”é™åˆ¶äº†ç”¨æˆ·è‡ªå®šä¹‰ç§å­çš„çµæ´»æ€§ã€‚
*   **è¿è§„è¯æ® 3**: `src/dpeva/sampling/manager.py` ä¸­ç¡¬ç¼–ç é˜ˆå€¼ã€‚
    *   **ä½ç½®**: `L25`
    *   **ä»£ç ç‰‡æ®µ**: `direct_thr_init = 0.1`

---

#### 2. é—¨ç¦äºŒï¼šä»£ç çº¯å‡€åº¦ (Purity Gate) - ğŸ”´ FAILED

**2.1 ç¼ºå¤± Docstrings (Missing Docstrings) - [P1]**
> è§„åˆ™ï¼šæ‰€æœ‰å…¬å¼€æ¨¡å—ã€ç±»ã€å‡½æ•°å¿…é¡»æä¾›ç¬¦åˆ Google Style çš„ docstringã€‚

*   **è¿è§„è¯æ®**:
    *   **`src/dpeva/cli.py`**: å…¨æ–‡ä»¶æ— æ–‡æ¡£å­—ç¬¦ä¸²ã€‚`handle_train`, `handle_infer` ç­‰æ ¸å¿ƒå…¥å£å‡½æ•°æ²¡æœ‰ä»»ä½•å‚æ•°è¯´æ˜ã€‚
    *   **`src/dpeva/workflows/*.py`**: éƒ¨åˆ†å†…éƒ¨æ–¹æ³•ï¼ˆå¦‚ `_setup_logger`ï¼‰åŠ `run()` æ–¹æ³•çš„å‰¯ä½œç”¨æè¿°ç¼ºå¤±ã€‚
    *   **`src/dpeva/uncertain/calculator.py`**: æ ¸å¿ƒè®¡ç®—é€»è¾‘ç¼ºä¹å¯¹è¾“å…¥æ•°ç»„å½¢çŠ¶ï¼ˆshapeï¼‰çš„è¯´æ˜ã€‚

**2.2 å†—ä½™ä»£ç  (Redundant Code) - ğŸŸ¢ PASSED**
*   **æ£€æŸ¥ç»“æœ**: æœªå‘ç°è¶…è¿‡ 3 è¡Œçš„æ˜æ˜¾é‡å¤ä»£ç å—ã€‚
*   **æ­»ä»£ç **: æœªå‘ç°æœªä½¿ç”¨çš„ import æˆ–å¤§æ®µæ³¨é‡Šä»£ç ï¼ˆ`# TODO`/`# FIXME` æ‰«æç»“æœä¸º 0ï¼‰ã€‚

---

#### 3. é—¨ç¦ä¸‰ï¼šåŠŸèƒ½ä¸€è‡´æ€§ (Consistency Gate) - ğŸŸ¢ PASSED

**3.1 æ–‡æ¡£-æµ‹è¯•-ä»£ç  è¿½æº¯**
*   **Workflow ä¸€è‡´æ€§**:
    *   æ–‡æ¡£æè¿°çš„ "One-Task-One-Job" Slurm æäº¤æ¨¡å¼åœ¨ `src/dpeva/submission/manager.py` ä¸­æœ‰å¯¹åº”å®ç°ã€‚
    *   `Training` å’Œ `Inference` å·¥ä½œæµå‡æœ‰å¯¹åº”çš„é›†æˆæµ‹è¯•è¦†ç›– (`tests/integration/test_slurm_multidatapool_e2e.py`, `tests/integration/test_inference_parallel_submission.py`)ã€‚
*   **åŠŸèƒ½è¦†ç›–**:
    *   æ–‡æ¡£æåŠçš„ "Auto-UQ" å’Œ "2-Step DIRECT Sampling" åœ¨ `src/dpeva/uncertain/` å’Œ `src/dpeva/sampling/` ä¸­å‡æœ‰å®Œæ•´å®ç°ã€‚

---

#### 4. ä¸Šä¸€æ¬¡å®¡è®¡æŠ¥å‘Šå¯¹æ¯” (Review of Previous Audit)

é˜…è¯» `docs/reports/2026-02-27-Code-Audit_Report.md` åï¼Œæˆ‘ç¡®è®¤ï¼š
1.  **å®Œå…¨ä¸€è‡´**: ä¸Šæ¬¡å®¡è®¡æŒ‡å‡ºçš„ "Hardcoded Paths in visualization.py" å’Œ "Magic Numbers in managers.py" **ç¡®å®å­˜åœ¨**ï¼Œä¸”è‡³ä»Šæœªè¢«ä¿®å¤ã€‚
2.  **è¡¥å……å‘ç°**: ä¸Šæ¬¡å®¡è®¡æœªæ˜ç¡®æŒ‡å‡ºçš„ `cli.py` ç¼ºå¤±æ–‡æ¡£é—®é¢˜ï¼Œæœ¬æ¬¡å®¡è®¡ç¡®è®¤ä¸ºä¸¥é‡è¿è§„ï¼ˆP1ï¼‰ï¼Œå› ä¸º CLI æ˜¯ç”¨æˆ·äº¤äº’çš„ç¬¬ä¸€å…¥å£ã€‚
3.  **ç»“è®ºè®¤åŒ**: åŒæ„ä¸Šæ¬¡å®¡è®¡çš„ "FAILED" ç»“è®ºï¼Œé¡¹ç›®å¿…é¡»å…ˆè§£å†³è¿™äº›æŠ€æœ¯å€ºåŠ¡æ‰èƒ½è¿›è¡Œä¸‹ä¸€é˜¶æ®µçš„åŠŸèƒ½å¼€å‘ã€‚

---

### B. é—®é¢˜ä¿®å¤ä»»åŠ¡åˆ—è¡¨ (Issue Fix Task List)

ä¸ºäº†é€šè¿‡å®¡è®¡é—¨ç¦ï¼Œè¯·æŒ‰ä¼˜å…ˆçº§æ‰§è¡Œä»¥ä¸‹ä¿®å¤ä»»åŠ¡ï¼š

| ID | ä¼˜å…ˆçº§ | ä»»åŠ¡ç±»å‹ | æè¿° | æ¶‰åŠæ–‡ä»¶ |
| :--- | :--- | :--- | :--- | :--- |
| **FIX-01** | **P0** | Refactor | **æ¶ˆé™¤ç¡¬ç¼–ç è·¯å¾„**ï¼šå°† `visualization.py` ä¸­çš„å­—ç¬¦ä¸²è·¯å¾„æ‹¼æ¥æ”¹ä¸º `os.path.join` æˆ– `pathlib.Path`ã€‚ | `src/dpeva/uncertain/visualization.py` |
| **FIX-02** | **P0** | Refactor | **æå–å¸¸é‡**ï¼šå°† `eV/atom`, `eV/A` ç­‰ç‰©ç†å•ä½æå–åˆ° `src/dpeva/constants.py` ä¸­ï¼Œå¹¶åœ¨ `managers.py` ä¸­å¼•ç”¨ã€‚ | `src/dpeva/analysis/managers.py`, `src/dpeva/constants.py` |
| **FIX-03** | **P1** | Refactor | **é…ç½®åŒ–ç§å­**ï¼šå°† `default_seeds` åˆ—è¡¨ç§»è‡³ `constants.py` æˆ–é€šè¿‡ `config.py` æ³¨å…¥ï¼Œé¿å…åœ¨é€»è¾‘ä»£ç ä¸­ç¡¬ç¼–ç ã€‚ | `src/dpeva/training/managers.py` |
| **FIX-04** | **P1** | Docs | **è¡¥å…¨ CLI æ–‡æ¡£**ï¼šä¸º `cli.py` ä¸­çš„æ‰€æœ‰ `handle_*` å‡½æ•°æ·»åŠ  Google Style Docstringï¼Œè¯´æ˜å‚æ•° args çš„ç»“æ„ã€‚ | `src/dpeva/cli.py` |
| **FIX-05** | **P2** | Docs | **è¡¥å…¨ Workflow æ–‡æ¡£**ï¼šå®Œå–„ `TrainingWorkflow` å’Œ `InferenceWorkflow` ç±»åŠå…¶æ–¹æ³•çš„æ–‡æ¡£å­—ç¬¦ä¸²ã€‚ | `src/dpeva/workflows/*.py` |